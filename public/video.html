<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0">
    <link rel="stylesheet" href="/css/main.css">
    <title>WebRTC video stream</title>
</head>
<body>
    <div class="container">
        <button id="selectStreamButton" onclick="initiateStream()">Select stream</button>
        <video id="localVideo" autoplay playsinline controls="false"></video>
        <video id="remoteVideo" autoplay playsinline controls="false"></video>
    </div>
</body>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const localVideo = document.getElementById('localVideo')
    const remoteVideo = document.getElementById('remoteVideo')
    const roomID = window.location.pathname.split('/')[window.location.pathname.split('/').length-1]
    const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]}
    const peerConnection = new RTCPeerConnection(configuration)
    var selfID = ""
    var resolution = { width: 1280, height: 720, framerate: 30 }
    
    socket.on('ID', (data) => {
        console.log("My ID is", data)
        selfID = data
        socket.emit('joinRoom', roomID)
    })

    function initiateStream() {
        navigator.mediaDevices.getDisplayMedia({
            audio: false,
            video: {
                chromeMediaSource: 'desktop',
                width: resolution.width,
                height: resolution.height,
                frameRate: resolution.framerate
                }   
        }).then(stream => {
            localVideo.srcObject = stream
        }).catch(err => {
            console.log('nay', err)
        })
    }

    async function gotPeerAnswer(answer) {
        console.log('incomingPeerAnswer');
        console.log(answer);
        const remoteDesc = new RTCSessionDescription(answer)
        await peerConnection.setRemoteDescription(remoteDesc)
    }

    async function answerIncomingPeerOffer(data) {
        console.log('incoming Peer offer');
        console.log(data.offer);
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        console.log('created answer:');
        console.log(answer)
        socket.emit('makePeerAnswer', {answer: answer, offerer: data.offerer})
    }

    async function handleICEcandidate(candidate) {
        try {
            await peerConnection.addIceCandidate(candidate)
        } catch (e) {
            console.error('Error adding received ice candidate', e)
        }
    }

    async function makeCall() {
        console.log('Initiating Peer connection')

        //socket listen for accepted offers / answers

        socket.on('incomingPeerAnswer', answer => {
            gotPeerAnswer(answer)
        })

        //signalingChannel.addEventListener('message', async message => {
        //    if (message.answer) {
        //        const remoteDesc = new RTCSessionDescription(message.answer)
        //        await peerConnection.setRemoteDescription(remoteDesc)
        //    }
        //})
            

        const offer = await peerConnection.createOffer()
        await peerConnection.setLocalDescription(offer)

        //socket send offer
        socket.emit('makePeerOffer',{offer: offer, roomID: roomID})

        //signalingChannel.send({'offer': offer})
    }

    //listen for incoming peer offers
    socket.on('incomingPeerOffer', data => {
        answerIncomingPeerOffer(data)
    })
    
    

    //              ICE CANDIDATES

    // Listen for local ICE candidates on the local RTCPeerConnection
    //peerConnection.addEventListener('icecandidate', event => {
    //    if (event.candidate) {
    //        socket.emit('new-ice-candidate', {candidate: event.candidate})
    //    }
    //})
    peerConnection.onicecandidate = function(event) {
        console.log(event);
        if (event.candidate) {
            socket.emit('new-ice-candidate', {candidate: event.candidate})
        }
    }

    // Listen for remote ICE candidates and add them to the local RTCPeerConnection
    socket.on('incomingICEcandidate', candidate => {
        handleICEcandidate(candidate)
    })

    peerConnection.addEventListener('connectionstatechange', event => {
        if (peerConnection.connectionState === 'connected') {
            console.log("P2P connection established!");
            }
        })
    
    window.onload = makeCall
</script>

</html>